<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Ustaz AI - Digital Dakwah Platform</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="Get instant Islamic guidance from Ustaz Radhi AI, your 24/7 digital Islamic scholar. Ask questions about prayer, halal lifestyle, and Islamic teachings for Sabah's Muslim community.">
    <meta name="keywords" content="Islamic AI, digital ustaz, Islamic guidance Sabah, Muslim chatbot, Islamic questions, prayer times Sabah, halal guidance Malaysia">
    <meta property="og:title" content="Ask Ustaz AI - Digital Islamic Guidance">
    <meta property="og:description" content="Get instant Islamic guidance from your digital ustaz, available 24/7 for Sabah's Muslim community">
    <meta property="og:url" content="https://digital.zikirnurani.com/ustaz.html">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://digital.zikirnurani.com/assets/ustaz-og.jpg">
    <link rel="canonical" href="https://digital.zikirnurani.com/ustaz.html">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Google Generative AI SDK -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    
    <!-- Load Configuration -->
    <script src="config.js"></script>
    
    <style>
        body { font-family: 'Sora', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .ai-status {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        #translateButton {
            position: fixed;
            top: 160px;
            right: 20px;
            z-index: 1000;
        }
        /* Hide Google Translate banner and styling */
        .goog-te-banner-frame {
            display: none !important;
        }
        .goog-te-combo {
            display: none !important;
        }
        #google_translate_element {
            display: none !important;
        }
        body {
            top: 0 !important;
        }
        .status-connected { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; }
        .status-disconnected { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .status-thinking { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
    </style>
</head>
<body class="text-gray-200 bg-[#000711]">
    <!-- AI Status Indicator -->
    <div id="aiStatus" class="ai-status glass-card px-4 py-2 rounded-lg border status-disconnected">
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 rounded-full bg-red-400" id="statusDot"></div>
            <span class="text-xs" id="statusText">AI Offline</span>
        </div>
    </div>

    <!-- Translation Button -->
    <div id="translateButton" class="fixed top-100 right-20 mt-16 z-1000">
        <button id="langToggle" onclick="toggleLanguage()" class="glass-card px-4 py-2 rounded-lg border border-amber-400 text-amber-300 hover:bg-amber-500/20 transition-all duration-300 text-sm font-semibold">
            üåè Bahasa Melayu
        </button>
    </div>

    <header class="fixed top-0 left-0 right-0 z-50 bg-[#000711]/80 backdrop-blur">
        <div class="container mx-auto px-6 py-4">
            <div class="glass-card rounded-full px-6 py-2 flex justify-between items-center">
                <h1 class="text-lg font-bold text-white">Digital Dakwah Platform</h1>
                <nav class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-300 hover:text-white transition">Home</a>
                    <a href="marketplace.html" class="text-gray-300 hover:text-white transition">Marketplace</a>
                    <a href="ustaz.html" class="text-white">Ask Ustaz</a>
                    <a href="mindmap.html" class="text-gray-300 hover:text-white transition">Mindmap</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-32 pb-20">
        <div class="container mx-auto px-6">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6">
                    Ask <span class="text-gradient bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">Ustaz AI</span>
                </h1>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">
                    Meet Ustaz Radhi from Papar, Sabah - your trusted Islamic guide with deep local roots. Get personalized guidance rooted in Quran and Sunnah, with intimate understanding of our Sabahan culture and traditions.
                </p>
            </div>

            <!-- Chat Interface -->
            <div class="max-w-4xl mx-auto">
                <div class="glass-card rounded-lg p-6 mb-6">
                    <div class="chat-container h-96 overflow-y-auto mb-6" id="chatMessages">
                        <!-- Welcome Message -->
                        <div class="chat-message flex items-start space-x-3 mb-4" id="welcomeMessage">
                            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">ü§ñ</span>
                            </div>
                            <div class="flex-1 bg-gradient-to-r from-green-500/20 to-blue-600/20 rounded-lg p-4">
                                <p class="text-white">Assalamu'alaikum! üåô<br><br>I'm <strong>Ustaz Radhi</strong> from Papar, Sabah. I help answer Islamic questions in simple, easy ways. <br><br>What's your name? This helps me give you better answers. üòä</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator chat-message flex items-start space-x-3 mb-4" id="typingIndicator">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm">ü§ñ</span>
                        </div>
                        <div class="flex-1 bg-gradient-to-r from-green-500/20 to-blue-600/20 rounded-lg p-4">
                            <p class="text-white">Ustaz Radhi is thinking... ü§î</p>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="flex space-x-4">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask Ustaz AI your Islamic question here..." 
                            class="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400"
                        >
                        <button 
                            id="sendButton"
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white rounded-lg transition-all duration-300 hover:scale-105"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Topics -->
            <div class="max-w-4xl mx-auto mb-12">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Common Questions</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What are the prayer times in Sabah?">
                        <div class="text-green-300 font-semibold mb-2">Prayer Times</div>
                        <div class="text-gray-400 text-sm">Learn about prayer schedules in Sabah</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to perform wudu correctly?">
                        <div class="text-blue-300 font-semibold mb-2">Wudu Guide</div>
                        <div class="text-gray-400 text-sm">Step-by-step ablution instructions</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What foods are halal in Sabahan cuisine?">
                        <div class="text-purple-300 font-semibold mb-2">Halal Food</div>
                        <div class="text-gray-400 text-sm">Sabahan halal dietary guidelines</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to find qibla direction in Sabah?">
                        <div class="text-yellow-300 font-semibold mb-2">Qibla Direction</div>
                        <div class="text-gray-400 text-sm">Finding prayer direction in Sabah</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What are the pillars of Islam?">
                        <div class="text-red-300 font-semibold mb-2">Five Pillars</div>
                        <div class="text-gray-400 text-sm">Fundamental Islamic practices</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to calculate zakat in Malaysia?">
                        <div class="text-indigo-300 font-semibold mb-2">Zakat Calculation</div>
                        <div class="text-gray-400 text-sm">Malaysian zakat guidelines</div>
                    </button>
                </div>
            </div>

            <!-- Islamic Resources -->
            <div class="max-w-4xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Islamic Resources</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">üìñ</div>
                        <h4 class="text-lg font-bold text-green-300 mb-2">Quran Online</h4>
                        <p class="text-gray-400 text-sm mb-4">Read Quran with Malay translation</p>
                        <a href="https://quran.com/ms" target="_blank" rel="noopener" class="text-green-400 hover:text-green-300 text-sm">Read Now ‚Üí</a>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">üïå</div>
                        <h4 class="text-lg font-bold text-blue-300 mb-2">Mosque Finder</h4>
                        <p class="text-gray-400 text-sm mb-4">Find nearby mosques in Sabah</p>
                        <button class="text-blue-400 hover:text-blue-300 text-sm">Find Mosques ‚Üí</button>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">üìö</div>
                        <h4 class="text-lg font-bold text-purple-300 mb-2">Islamic Library</h4>
                        <p class="text-gray-400 text-sm mb-4">Access Islamic books and articles</p>
                        <button class="text-purple-400 hover:text-purple-300 text-sm">Browse Library ‚Üí</button>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">üõí</div>
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Halal Marketplace</h4>
                        <p class="text-gray-400 text-sm mb-4">Shop halal products from Sabah</p>
                        <a href="marketplace.html" class="text-amber-400 hover:text-amber-300 text-sm">Shop Now ‚Üí</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { GoogleGenerativeAI } from '@google/generative-ai';

        // Global variables
        let genAI = null;
        let model = null;
        let chatHistory = [];
        let userName = '';
        let isNameCaptured = false;

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const aiStatus = document.getElementById('aiStatus');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Update AI status
        function updateAIStatus(status, message) {
            const statusClass = `status-${status}`;
            aiStatus.className = `ai-status glass-card px-4 py-2 rounded-lg border ${statusClass}`;
            
            const colors = {
                connected: 'bg-green-400',
                disconnected: 'bg-red-400', 
                thinking: 'bg-blue-400'
            };
            
            statusDot.className = `w-2 h-2 rounded-full ${colors[status]}`;
            statusText.textContent = message;
        }

        // Add message to chat
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3 mb-4';
            
            const avatarClass = isUser 
                ? 'bg-gradient-to-r from-purple-500 to-pink-600' 
                : 'bg-gradient-to-r from-green-500 to-blue-600';
            
            const avatarIcon = isUser ? 'üë§' : 'ü§ñ';
            const messageClass = isUser 
                ? 'bg-gradient-to-r from-purple-500/20 to-pink-600/20' 
                : 'bg-gradient-to-r from-green-500/20 to-blue-600/20';
            
            messageDiv.innerHTML = `
                <div class="flex-shrink-0 w-10 h-10 ${avatarClass} rounded-full flex items-center justify-center">
                    <span class="text-white text-sm">${avatarIcon}</span>
                </div>
                <div class="flex-1 ${messageClass} rounded-lg p-4">
                    <p class="text-white">${message.replace(/\n/g, '<br>')}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Initialize Gemini AI
        async function initializeGeminiAI() {
            try {
                // Your Gemini API Key
                const API_KEY = 'AIzaSyCpJ2hv2x4AJeofGNlISs-_9AEebuDF7OA';
                
                if (!API_KEY || API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    console.warn('Gemini API key not configured. Using fallback responses.');
                    updateAIStatus('disconnected', 'API Key Required');
                    return false;
                }

                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ 
                    model: 'gemini-1.5-pro',  // Changed to more stable model
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 1000,  // Increased for better responses
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE",
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE",
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE",
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE",
                        },
                    ]
                });

                console.log('‚úÖ Gemini AI initialized successfully with stable model');
                updateAIStatus('connected', 'Ustaz Radhi Ready');
                return true;
            } catch (error) {
                console.error('‚ùå Failed to initialize Gemini AI:', error);
                updateAIStatus('disconnected', 'AI Error');
                return false;
            }
        }

        // Enhanced Generate AI response with retry mechanism
        async function generateAIResponse(message, retryCount = 0) {
            const maxRetries = 3;
            const retryDelay = Math.pow(2, retryCount) * 1000; // Exponential backoff: 1s, 2s, 4s

            if (!model) {
                throw new Error('Gemini AI model not initialized');
            }

            const islamicContext = `
            You are Ustaz Radhi from Papar, Sabah. Give simple, direct answers about Islam.
            
            Rules for your replies:
            - Keep answers SHORT (2-3 sentences maximum)
            - Go straight to the point
            - Use simple, easy words
            - Give practical advice for daily life
            - Use the person's name: ${userName || 'my friend'}
            - End with a simple dua or blessing
            
            Make it conversational like talking to a neighbor, not a formal speech.
            
            Question: ${message}
            `;

            try {
                const result = await model.generateContent(islamicContext);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error(`Error generating AI response (attempt ${retryCount + 1}):`, error);
                
                // Check if it's a 503 error (service unavailable) and we haven't exceeded max retries
                if (error.message.includes('503') || error.message.includes('overloaded') || error.message.includes('Service Unavailable')) {
                    if (retryCount < maxRetries) {
                        console.log(`Retrying in ${retryDelay}ms... (attempt ${retryCount + 2}/${maxRetries + 1})`);
                        updateAIStatus('thinking', `Reconnecting... (${retryCount + 2}/${maxRetries + 1})`);
                        
                        await new Promise(resolve => setTimeout(resolve, retryDelay));
                        return generateAIResponse(message, retryCount + 1);
                    } else {
                        console.warn('Max retries exceeded, falling back to offline responses');
                        updateAIStatus('disconnected', 'Service Overloaded');
                        throw new Error('GEMINI_OVERLOADED');
                    }
                }
                
                throw error;
            }
        }

        // Fallback responses for when AI is not available
        const fallbackResponses = {
            'prayer': 'In Sabah, prayer times are: Fajr 5:45am, Dhuhr 12:30pm, Asr 3:45pm, Maghrib 6:55pm, Isha 8:10pm. Check your local mosque for exact times. May Allah accept your prayers.',
            
            'wudu': 'Wudu steps: 1) Say Bismillah 2) Wash hands 3x 3) Rinse mouth 3x 4) Clean nose 3x 5) Wash face 3x 6) Wash arms 3x 7) Wipe head 1x 8) Wash feet 3x. Done!',
            
            'halal': 'In Sabah: hinava, bambangan, and local seafood are halal. Always buy JAKIM certified meat. When in doubt, ask or avoid. Allah loves careful Muslims.',
            
            'qibla': 'In Sabah, face West-Northwest (around 295-300 degrees). Use a qibla app for exact direction. Allah sees your effort to face the right way.',
            
            'pillars': 'Five Pillars: 1) Shahada 2) 5 daily prayers 3) Zakat 4) Ramadan fasting 5) Hajj if able. These are the basics of Islam.',
            
            'zakat': 'In Malaysia: pay 2.5% of savings above RM14,000 yearly. Contact local zakat office for help. Zakat cleans your wealth and helps others.',
            
            'dua': 'Best duas: Astaghfirullah (for forgiveness), Allahumma salli ala Muhammad (blessings on Prophet), La hawla wa la quwwata illa billah (for strength). Allah hears all prayers.',
            
            'ramadan': 'Ramadan fasting: stop eating at Fajr (5:30am), break fast at Maghrib (7:00pm). Read Quran, give charity, make dua. Ramadan Mubarak!',
            
            'quran': 'Read Quran daily, even one verse. Start with Al-Fatiha, Al-Ikhlas, Al-Falaq, An-Nas. Get a Malay translation to understand better.',
            
            'marriage': 'Islamic marriage needs: good character, faith compatibility, family involvement, and Istikhara prayer. Marriage is half your deen.',
            
            'default': 'Sorry, I have technical problems right now. Please ask again later or visit your local mosque. The ustaz there can help you better.'
        };

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            const nameGreeting = userName ? `${userName}, ` : 'my dear brother or sister, ';
            
            // More comprehensive keyword matching
            const keywords = {
                'prayer': ['prayer', 'solat', 'salah', 'pray', 'time', 'waktu'],
                'wudu': ['wudu', 'ablution', 'purification', 'cleanse', 'wash'],
                'halal': ['halal', 'haram', 'food', 'eat', 'makanan', 'forbidden'],
                'qibla': ['qibla', 'kiblat', 'direction', 'mecca', 'makkah', 'face'],
                'pillars': ['pillar', 'rukun', 'five', 'foundation', 'basic'],
                'zakat': ['zakat', 'charity', 'wealth', 'money', 'savings'],
                'dua': ['dua', 'pray', 'supplication', 'invoke', 'ask allah'],
                'ramadan': ['ramadan', 'fasting', 'puasa', 'iftar', 'sahur'],
                'quran': ['quran', 'qur\'an', 'read', 'recite', 'surah', 'ayah'],
                'marriage': ['marriage', 'nikah', 'wife', 'husband', 'marry', 'wedding']
            };
            
            for (const [category, words] of Object.entries(keywords)) {
                if (words.some(word => lowerMessage.includes(word))) {
                    return fallbackResponses[category].replace('my dear brother or sister', nameGreeting.slice(0, -2));
                }
            }
            
            return fallbackResponses.default.replace('my dear brother or sister', nameGreeting.slice(0, -2));
        }

        // Enhanced send message function with name capture and better error handling
        async function sendMessage(message = null) {
            const userMessage = message || messageInput.value.trim();
            if (!userMessage) return;

            // Add user message
            addMessage(userMessage, true);
            
            // Clear input
            if (!message) messageInput.value = '';

            // Check if this is the first interaction (name capture)
            if (!isNameCaptured) {
                userName = userMessage;
                isNameCaptured = true;
                
                // Welcome response with name
                const welcomeResponse = `Nice to meet you, ${userName}! üòä

I'm Ustaz Radhi from Papar, Sabah. I'm here to help answer your Islamic questions in simple, easy ways.

What would you like to know about Islam today, ${userName}? ü§≤`;

                addMessage(welcomeResponse);
                return;
            }

            // Show typing indicator
            updateAIStatus('thinking', 'Ustaz Radhi is contemplating...');
            typingIndicator.style.display = 'flex';

            try {
                let response;
                
                // Try AI response first with retry logic
                if (model) {
                    try {
                        response = await generateAIResponse(userMessage);
                        updateAIStatus('connected', 'Ustaz Radhi Ready');
                    } catch (aiError) {
                        console.warn('AI service unavailable, using fallback:', aiError.message);
                        response = getFallbackResponse(userMessage);
                        updateAIStatus('disconnected', 'Using Offline Knowledge');
                    }
                } else {
                    // Use fallback response
                    response = getFallbackResponse(userMessage);
                    updateAIStatus('disconnected', 'Using Offline Knowledge');
                }

                // Add AI response
                addMessage(response);
                
            } catch (error) {
                console.error('Error in sendMessage:', error);
                const fallbackResponse = getFallbackResponse(userMessage);
                addMessage(fallbackResponse);
                updateAIStatus('disconnected', 'Service Error');
            } finally {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize AI
            await initializeGeminiAI();

            // Send button click
            sendButton.addEventListener('click', () => sendMessage());

            // Enter key press
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Topic buttons
            document.querySelectorAll('.topic-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const topic = this.getAttribute('data-topic');
                    sendMessage(topic);
                });
            });

            // Initialize Google Translate
            // Create hidden div for Google Translate element
            const translateDiv = document.createElement('div');
            translateDiv.id = 'google_translate_element';
            translateDiv.style.display = 'none';
            document.body.appendChild(translateDiv);
            
            // Load Google Translate API
            const script = document.createElement('script');
            script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
            document.head.appendChild(script);
        });

        // Make functions available globally for debugging
        window.sendMessage = sendMessage;
        window.initializeGeminiAI = initializeGeminiAI;
        
        // Translation variables
        let isTranslated = false;
        let translateElementInitialized = false;
        
        // Initialize Google Translate on page load
        window.googleTranslateElementInit = function() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'ms,en',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
            translateElementInitialized = true;
        };
        
        // Language toggle function
        window.toggleLanguage = function() {
            const button = document.getElementById('langToggle');
            
            if (!translateElementInitialized) {
                button.innerHTML = 'üîÑ Loading translator...';
                setTimeout(() => window.toggleLanguage(), 1000);
                return;
            }
            
            const selectElement = document.querySelector('.goog-te-combo');
            if (!selectElement) {
                button.innerHTML = '‚ö†Ô∏è Translator not ready';
                setTimeout(() => {
                    button.innerHTML = isTranslated ? 'üåè English' : 'üåè Bahasa Melayu';
                }, 2000);
                return;
            }
            
            if (!isTranslated) {
                // Translate to Malay
                button.innerHTML = 'üîÑ Menterjemah...';
                button.disabled = true;
                
                selectElement.value = 'ms';
                selectElement.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    button.innerHTML = 'üåè English';
                    button.disabled = false;
                    isTranslated = true;
                }, 2000);
            } else {
                // Translate back to English
                button.innerHTML = 'üîÑ Translating...';
                button.disabled = true;
                
                selectElement.value = 'en';
                selectElement.dispatchEvent(new Event('change'));
                
                setTimeout(() => {
                    button.innerHTML = 'üåè Bahasa Melayu';
                    button.disabled = false;
                    isTranslated = false;
                }, 2000);
            }
        };
    </script>
</body>
</html>