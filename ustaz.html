<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ask Ustaz - Digital Dakwah Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Load Google Generative AI SDK -->
    <script type="importmap">
    {
        "imports": {
            "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
    }
    </script>
    
    <!-- Load Configuration -->
    <script src="config.js"></script>
    
    <style>
        body { font-family: 'Sora', sans-serif; }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            animation: fadeInUp 0.5s ease-out;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator {
            display: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        .ai-status {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .status-connected { background: rgba(34, 197, 94, 0.2); border-color: #22c55e; }
        .status-disconnected { background: rgba(239, 68, 68, 0.2); border-color: #ef4444; }
        .status-thinking { background: rgba(59, 130, 246, 0.2); border-color: #3b82f6; }
    </style>
</head>
<body class="text-gray-200 bg-[#000711]">
    <!-- AI Status Indicator -->
    <div id="aiStatus" class="ai-status glass-card px-4 py-2 rounded-lg border status-disconnected">
        <div class="flex items-center space-x-2">
            <div class="w-2 h-2 rounded-full bg-red-400" id="statusDot"></div>
            <span class="text-xs" id="statusText">AI Offline</span>
        </div>
    </div>

    <header class="fixed top-0 left-0 right-0 z-50 bg-[#000711]/80 backdrop-blur">
        <div class="container mx-auto px-6 py-4">
            <div class="glass-card rounded-full px-6 py-2 flex justify-between items-center">
                <h1 class="text-lg font-bold text-white">Digital Dakwah Platform</h1>
                <nav class="hidden md:flex space-x-6">
                    <a href="index.html" class="text-gray-300 hover:text-white transition">Home</a>
                    <a href="marketplace.html" class="text-gray-300 hover:text-white transition">Marketplace</a>
                    <a href="ustaz.html" class="text-white">Ask Ustaz</a>
                    <a href="mindmap.html" class="text-gray-300 hover:text-white transition">Mindmap</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="pt-32 pb-20">
        <div class="container mx-auto px-6">
            <div class="text-center mb-12">
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-6">
                    Ask <span class="text-gradient bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">Ustaz AI</span>
                </h1>
                <p class="text-xl text-gray-300 max-w-2xl mx-auto">
                    Get instant Islamic guidance powered by AI, trained on authentic Islamic knowledge and Sabahan context
                </p>
            </div>

            <!-- Chat Interface -->
            <div class="max-w-4xl mx-auto">
                <div class="glass-card rounded-lg p-6 mb-6">
                    <div class="chat-container h-96 overflow-y-auto mb-6" id="chatMessages">
                        <!-- Welcome Message -->
                        <div class="chat-message flex items-start space-x-3 mb-4">
                            <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                                <span class="text-white text-sm">🤖</span>
                            </div>
                            <div class="flex-1 bg-gradient-to-r from-green-500/20 to-blue-600/20 rounded-lg p-4">
                                <p class="text-white">Assalamu'alaikum! I'm your AI Ustaz assistant. Ask me any Islamic questions, and I'll provide guidance based on Quran and Sunnah, with consideration for Sabahan context. How can I help you today?</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div class="typing-indicator chat-message flex items-start space-x-3 mb-4" id="typingIndicator">
                        <div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm">🤖</span>
                        </div>
                        <div class="flex-1 bg-gradient-to-r from-green-500/20 to-blue-600/20 rounded-lg p-4">
                            <p class="text-white">Ustaz AI is thinking...</p>
                        </div>
                    </div>
                    
                    <!-- Input Area -->
                    <div class="flex space-x-4">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="Ask your Islamic question here..." 
                            class="flex-1 px-4 py-3 rounded-lg bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-green-400"
                        >
                        <button 
                            id="sendButton"
                            class="px-6 py-3 bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white rounded-lg transition-all duration-300 hover:scale-105"
                        >
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Topics -->
            <div class="max-w-4xl mx-auto mb-12">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Common Questions</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What are the prayer times in Sabah?">
                        <div class="text-green-300 font-semibold mb-2">Prayer Times</div>
                        <div class="text-gray-400 text-sm">Learn about prayer schedules in Sabah</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to perform wudu correctly?">
                        <div class="text-blue-300 font-semibold mb-2">Wudu Guide</div>
                        <div class="text-gray-400 text-sm">Step-by-step ablution instructions</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What foods are halal in Sabahan cuisine?">
                        <div class="text-purple-300 font-semibold mb-2">Halal Food</div>
                        <div class="text-gray-400 text-sm">Sabahan halal dietary guidelines</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to find qibla direction in Sabah?">
                        <div class="text-yellow-300 font-semibold mb-2">Qibla Direction</div>
                        <div class="text-gray-400 text-sm">Finding prayer direction in Sabah</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="What are the pillars of Islam?">
                        <div class="text-red-300 font-semibold mb-2">Five Pillars</div>
                        <div class="text-gray-400 text-sm">Fundamental Islamic practices</div>
                    </button>
                    <button class="topic-btn glass-card p-4 rounded-lg hover:transform hover:scale-105 transition-all duration-300 text-left" data-topic="How to calculate zakat in Malaysia?">
                        <div class="text-indigo-300 font-semibold mb-2">Zakat Calculation</div>
                        <div class="text-gray-400 text-sm">Malaysian zakat guidelines</div>
                    </button>
                </div>
            </div>

            <!-- Islamic Resources -->
            <div class="max-w-4xl mx-auto">
                <h3 class="text-2xl font-bold text-white mb-6 text-center">Islamic Resources</h3>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">📖</div>
                        <h4 class="text-lg font-bold text-green-300 mb-2">Quran Online</h4>
                        <p class="text-gray-400 text-sm mb-4">Read Quran with Malay translation</p>
                        <a href="quran.html" class="text-green-400 hover:text-green-300 text-sm">Read Now →</a>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">🕌</div>
                        <h4 class="text-lg font-bold text-blue-300 mb-2">Mosque Finder</h4>
                        <p class="text-gray-400 text-sm mb-4">Find nearby mosques in Sabah</p>
                        <button class="text-blue-400 hover:text-blue-300 text-sm">Find Mosques →</button>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">📚</div>
                        <h4 class="text-lg font-bold text-purple-300 mb-2">Islamic Library</h4>
                        <p class="text-gray-400 text-sm mb-4">Access Islamic books and articles</p>
                        <button class="text-purple-400 hover:text-purple-300 text-sm">Browse Library →</button>
                    </div>
                    <div class="glass-card rounded-lg p-6 text-center hover:transform hover:scale-105 transition-all duration-300">
                        <div class="text-4xl mb-4">🛒</div>
                        <h4 class="text-lg font-bold text-amber-300 mb-2">Halal Marketplace</h4>
                        <p class="text-gray-400 text-sm mb-4">Shop halal products from Sabah</p>
                        <a href="marketplace.html" class="text-amber-400 hover:text-amber-300 text-sm">Shop Now →</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { GoogleGenerativeAI } from '@google/generative-ai';

        // Global variables
        let genAI = null;
        let model = null;
        let chatHistory = [];

        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        const aiStatus = document.getElementById('aiStatus');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        // Update AI status
        function updateAIStatus(status, message) {
            const statusClass = `status-${status}`;
            aiStatus.className = `ai-status glass-card px-4 py-2 rounded-lg border ${statusClass}`;
            
            const colors = {
                connected: 'bg-green-400',
                disconnected: 'bg-red-400', 
                thinking: 'bg-blue-400'
            };
            
            statusDot.className = `w-2 h-2 rounded-full ${colors[status]}`;
            statusText.textContent = message;
        }

        // Initialize Gemini AI
        async function initializeGeminiAI() {
            try {
                // Your Gemini API Key
                const API_KEY = 'AIzaSyCpJ2hv2x4AJeofGNlISs-_9AEebuDF7OA';
                
                if (!API_KEY || API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                    console.warn('Gemini API key not configured. Using fallback responses.');
                    updateAIStatus('disconnected', 'API Key Required');
                    return false;
                }

                genAI = new GoogleGenerativeAI(API_KEY);
                model = genAI.getGenerativeModel({ 
                    model: 'gemini-1.5-flash',
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.95,
                        maxOutputTokens: 500,
                    }
                });

                console.log('✅ Gemini AI initialized successfully');
                updateAIStatus('connected', 'AI Ready');
                return true;
            } catch (error) {
                console.error('❌ Failed to initialize Gemini AI:', error);
                updateAIStatus('disconnected', 'AI Error');
                return false;
            }
        }

        // Generate AI response
        async function generateAIResponse(message) {
            if (!model) {
                throw new Error('Gemini AI model not initialized');
            }

            const islamicContext = `
            You are an Islamic scholar (Ustaz) AI assistant serving the Muslim community in Sabah, Malaysia. 
            Please provide guidance based on:
            - Quran and authentic Hadith
            - Consideration for Malaysian/Sabahan context
            - Respectful and compassionate tone
            - Practical advice for daily Islamic life
            
            Question: ${message}
            `;

            try {
                const result = await model.generateContent(islamicContext);
                const response = await result.response;
                return response.text();
            } catch (error) {
                console.error('Error generating AI response:', error);
                throw error;
            }
        }

        // Fallback responses for when AI is not available
        const fallbackResponses = {
            'prayer': 'For prayer times in Sabah, I recommend checking with your local mosque or using a reliable prayer time app. Generally, Fajr is around 5:45 AM, Dhuhr at 12:30 PM, Asr at 3:45 PM, Maghrib at 6:55 PM, and Isha at 8:10 PM in Kota Kinabalu.',
            'wudu': 'Wudu involves: 1) Intention (niyyah), 2) Wash hands 3 times, 3) Rinse mouth 3 times, 4) Clean nose 3 times, 5) Wash face 3 times, 6) Wash arms to elbows 3 times, 7) Wipe head once, 8) Wash feet to ankles 3 times.',
            'halal': 'In Sabahan cuisine, ensure meat is from halal-certified sources. Traditional foods like hinava (if using halal fish), bambangan, and local vegetables are generally halal. Always verify ingredients and preparation methods.',
            'qibla': 'In Sabah, the Qibla direction is generally West-Northwest (around 295-300 degrees). Use a reliable Qibla app or compass for precise direction in your specific location.',
            'pillars': 'The Five Pillars of Islam are: 1) Shahada (Declaration of Faith), 2) Salah (Prayer), 3) Zakat (Charity), 4) Sawm (Fasting during Ramadan), 5) Hajj (Pilgrimage to Mecca).',
            'zakat': 'In Malaysia, zakat calculation depends on income and savings. Generally, zakat on savings is 2.5% of wealth held for one year above the nisab threshold. Consult local zakat authorities for specific guidance.',
            'default': 'Assalamu\'alaikum. I apologize, but I\'m currently unable to provide a detailed response. Please consult with a local Ustaz or Islamic scholar for proper guidance on your question.'
        };

        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            for (const [key, response] of Object.entries(fallbackResponses)) {
                if (lowerMessage.includes(key)) {
                    return response;
                }
            }
            
            return fallbackResponses.default;
        }

        // Add message to chat
        function addMessage(message, isUser = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message flex items-start space-x-3 mb-4';
            
            const avatar = isUser 
                ? '<div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-600 rounded-full flex items-center justify-center"><span class="text-white text-sm">👤</span></div>'
                : '<div class="flex-shrink-0 w-10 h-10 bg-gradient-to-r from-green-500 to-blue-600 rounded-full flex items-center justify-center"><span class="text-white text-sm">🤖</span></div>';
            
            const bgColor = isUser 
                ? 'bg-gradient-to-r from-purple-500/20 to-pink-600/20'
                : 'bg-gradient-to-r from-green-500/20 to-blue-600/20';
            
            messageDiv.innerHTML = `
                ${avatar}
                <div class="flex-1 ${bgColor} rounded-lg p-4">
                    <p class="text-white">${message}</p>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Send message
        async function sendMessage(message = null) {
            const userMessage = message || messageInput.value.trim();
            if (!userMessage) return;

            // Add user message
            addMessage(userMessage, true);
            
            // Clear input
            if (!message) messageInput.value = '';

            // Show typing indicator
            updateAIStatus('thinking', 'AI Thinking...');
            typingIndicator.style.display = 'flex';

            try {
                let response;
                
                // Try AI response first
                if (model) {
                    response = await generateAIResponse(userMessage);
                } else {
                    // Use fallback response
                    response = getFallbackResponse(userMessage);
                }

                // Add AI response
                addMessage(response);
                updateAIStatus('connected', 'AI Ready');
                
            } catch (error) {
                console.error('Error getting AI response:', error);
                const fallbackResponse = getFallbackResponse(userMessage);
                addMessage(fallbackResponse);
                updateAIStatus('disconnected', 'Using Fallback');
            } finally {
                // Hide typing indicator
                typingIndicator.style.display = 'none';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize AI
            await initializeGeminiAI();

            // Send button click
            sendButton.addEventListener('click', () => sendMessage());

            // Enter key press
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            // Topic buttons
            document.querySelectorAll('.topic-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const topic = this.getAttribute('data-topic');
                    sendMessage(topic);
                });
            });
        });

        // Make functions available globally for debugging
        window.sendMessage = sendMessage;
        window.initializeGeminiAI = initializeGeminiAI;
    </script>
</body>
</html>